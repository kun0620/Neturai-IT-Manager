import{r as N,j as e,u as oe}from"./vendor-react-CQhyLJhi.js";import{X as ce}from"./vendor-radix-GaIC7jQ4.js";import{u as Y}from"./vendor-tanstack-CEdBqcEP.js";import{d as de,t as le,P as f,s as Z,b as F,N as ue,f as O,m as _,c as L,B as R}from"./index-C_wQioo6.js";import{L as me}from"./LoadingSkeleton-igMf2rTD.js";import{R as pe,S as w,L as xe,C as $,H as V,a as ge}from"./SummaryCard-BUxKZ7aw.js";import{R as E,L as he,X as Q,Y as G,T as I,b as q,P as fe,d as je,C as ve,B as ye,e as ke}from"./vendor-charts-yMFR7OPP.js";import{C as P,a as M,b as A,d as B}from"./card-CkIEAavX.js";import{B as W}from"./badge-07SJJ_S6.js";import{D as be}from"./download-CPP82sS_.js";import{s as H}from"./subDays-CxkVo8Mp.js";import"./vendor-supabase-ERkXFu1W.js";/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=de("Printer",[["polyline",{points:"6 9 6 2 18 2 18 9",key:"1306q4"}],["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["rect",{width:"12",height:"8",x:"6",y:"14",key:"5ipwut"}]]);function X(t,o){const a=le(t);if(isNaN(a.getTime()))throw new RangeError("Invalid time value");let s="",i="";const c="-",g=":";{const m=f(a.getDate(),2),j=f(a.getMonth()+1,2);s=`${f(a.getFullYear(),4)}${c}${j}${c}${m}`}{const m=a.getTimezoneOffset();if(m!==0){const T=Math.abs(m),y=f(Math.trunc(T/60),2),n=f(T%60,2);i=`${m<0?"+":"-"}${y}:${n}`}else i="Z";const j=f(a.getHours(),2),v=f(a.getMinutes(),2),d=f(a.getSeconds(),2),r=s===""?"":"T",C=[j,v,d].join(g);s=`${s}${r}${C}${i}`}return s}function Ne(t,o){return Y({queryKey:["report-overview",t,o],queryFn:async()=>{const{data:a,error:s}=await Z.from("tickets").select("id, title, status, priority, created_at, updated_at, due_at").gte("created_at",t).lte("created_at",o);if(s)throw s;const i=a??[];if(i.length===0)return{total:0,open:0,inProgress:0,closed:0,medianResolutionHours:null,overdue:0,slaBreaches:0};const c=i.length,g=i.filter(n=>n.status==="open").length,m=i.filter(n=>n.status==="in_progress").length,j=i.filter(n=>n.status==="closed").length,v=i.filter(n=>n.status==="closed"&&n.created_at&&n.updated_at);let d=null;if(v.length>0){const n=v.map(l=>{const k=new Date(l.created_at).getTime();return(new Date(l.updated_at).getTime()-k)/36e5}).sort((l,k)=>l-k),h=Math.floor(n.length/2);d=n.length%2!==0?n[h]:(n[h-1]+n[h])/2,d=Number(d.toFixed(1))}const r={low:72,medium:48,high:24,critical:8},C=Date.now(),T=i.filter(n=>{if(!n.created_at||!n.priority||n.status==="closed")return!1;const h=n.priority.toLowerCase(),l=r[h];if(!l)return!1;const k=new Date(n.created_at).getTime();return(C-k)/(1e3*60*60)>l}).length,y=i.filter(n=>n.due_at&&new Date(n.due_at).getTime()<C&&n.status!=="closed").length;return{total:c,open:g,inProgress:m,closed:j,medianResolutionHours:d,overdue:y,slaBreaches:T,tickets:a}}})}const Ce=ue("relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),J=N.forwardRef(({className:t,variant:o,...a},s)=>e.jsx("div",{ref:s,role:"alert",className:F(Ce({variant:o}),t),...a}));J.displayName="Alert";const ee=N.forwardRef(({className:t,...o},a)=>e.jsx("h5",{ref:a,className:F("mb-1 font-medium leading-none tracking-tight",t),...o}));ee.displayName="AlertTitle";const te=N.forwardRef(({className:t,...o},a)=>e.jsx("div",{ref:a,className:F("text-sm [&_p]:leading-relaxed",t),...o}));te.displayName="AlertDescription";function Te(t,o){return Y({queryKey:["tickets-trend",t,o],queryFn:async()=>{const{data:a,error:s}=await Z.from("tickets").select("created_at, status").gte("created_at",t).lte("created_at",o);if(s)throw s;return a??[]}})}function De({data:t}){const o=t.reduce((s,i)=>{const c=O(new Date(i.created_at),"MMM dd");return s[c]||(s[c]={date:c,open:0,closed:0}),i.status==="open"&&(s[c].open+=1),i.status==="closed"&&(s[c].closed+=1),s},{}),a=Object.values(o);return e.jsx("div",{className:"h-[260px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(he,{data:a,children:[e.jsx(Q,{dataKey:"date"}),e.jsx(G,{allowDecimals:!1}),e.jsx(I,{formatter:(s,i)=>[s,i==="open"?"Open Tickets":"Closed Tickets"]}),e.jsx(q,{type:"monotone",dataKey:"open",stroke:"#22c55e",strokeWidth:2,name:"Open"}),e.jsx(q,{type:"monotone",dataKey:"closed",stroke:"#3b82f6",strokeWidth:2,name:"Closed"})]})})})}const Re={open:"#22c55e",inProgress:"#eab308",closed:"#3b82f6"};function _e({data:t}){const o=[{name:"Open",value:t.open,key:"open"},{name:"In Progress",value:t.inProgress,key:"inProgress"},{name:"Closed",value:t.closed,key:"closed"}];return e.jsx("div",{className:"h-[260px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(fe,{children:[e.jsx(je,{data:o,dataKey:"value",innerRadius:60,outerRadius:90,paddingAngle:4,children:o.map(a=>e.jsx(ve,{fill:Re[a.key]},a.key))}),e.jsx(I,{formatter:(a,s)=>[`${a} tickets`,s]})]})})})}function Le({data:t}){const o=t.reduce((s,i)=>{const c=O(new Date(i.created_at),"MMM dd");return s[c]=(s[c]||0)+1,s},{}),a=Object.entries(o).map(([s,i])=>({date:s,count:i}));return e.jsx("div",{className:"h-[260px] w-full",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(ye,{data:a,children:[e.jsx(Q,{dataKey:"date"}),e.jsx(G,{allowDecimals:!1}),e.jsx(I,{formatter:s=>[`${s} tickets`,"Count"]}),e.jsx(ke,{dataKey:"count",fill:"#6366f1",radius:[4,4,0,0],name:"Tickets"})]})})})}const ze=()=>{const[t,o]=N.useState("7d"),[a,s]=N.useState(H(new Date,7)),[i,c]=N.useState(new Date),g=X(a),m=X(i),j=O(a,"yyyy-MM-dd"),v=O(i,"yyyy-MM-dd"),d=N.useMemo(()=>a.getTime()>i.getTime(),[a,i]),{data:r,isLoading:C,isError:T,error:y,isFetching:n,refetch:h}=Ne(g,m),{data:l,isLoading:k}=Te(g,m),b=oe(),se=()=>{if(!(r!=null&&r.tickets)||r.tickets.length===0||t==="custom"&&d)return;const p=u=>{if(u==null)return"";const z=String(u),ie=/[",\n\r]/.test(z),D=z.replace(/"/g,'""'),U=D.startsWith("=")||D.startsWith("+")||D.startsWith("-")||D.startsWith("@")?`'${D}`:D;return ie?`"${U}"`:U},x=["ID","Title","Status","Priority","Created At","Updated At","Due At"],ae=r.tickets.map(u=>[p(u.id),p(u.title??""),p(u.status),p(u.priority),p(u.created_at),p(u.updated_at),p(u.due_at)]),re=[x.join(","),...ae.map(u=>u.join(","))].join(`
`),ne=new Blob([re],{type:"text/csv;charset=utf-8;"}),K=URL.createObjectURL(ne),S=document.createElement("a");S.href=K,S.download=`tickets_report_${g.slice(0,10)}_${m.slice(0,10)}.csv`,S.click(),URL.revokeObjectURL(K)};return C||k?e.jsxs("div",{className:"flex flex-col gap-6 p-4 md:p-6",children:[e.jsx("div",{className:"h-8 w-1/2 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"h-6 w-1/3 bg-muted rounded animate-pulse"}),e.jsx(me,{count:6,className:"md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3"})]}):T?e.jsxs(J,{variant:"destructive",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx(ee,{children:"Error"}),e.jsxs(te,{children:["Failed to load reports: ",(y==null?void 0:y.message)||"Unknown error"]})]}):r?e.jsxs(_.div,{id:"report-print",className:"flex flex-col gap-6 p-4 md:p-6",...L(0),children:[e.jsxs(_.div,{className:"space-y-2",...L(.04),children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Neturai IT Manager"}),e.jsx("h1",{className:"text-3xl font-semibold",children:"IT Ticket Report"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Reporting period: ",g.slice(0,10)," → ",m.slice(0,10)]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(W,{variant:"outline",children:["Range: ",t==="custom"?"Custom":t==="7d"?"Last 7 days":"Last 30 days"]}),e.jsxs(W,{variant:"secondary",children:["Total: ",r.total]})]})]}),e.jsxs(_.div,{className:"flex flex-wrap items-center gap-2 rounded-lg border border-border/70 bg-card/60 p-2",...L(.08),children:[e.jsx(R,{type:"button",variant:t==="7d"?"default":"outline",size:"sm",className:`h-8 ${t==="7d"?"bg-primary text-primary-foreground":""}`,onClick:()=>{o("7d"),s(H(new Date,7)),c(new Date)},children:"Last 7 days"}),e.jsx(R,{type:"button",variant:t==="30d"?"default":"outline",size:"sm",className:`h-8 ${t==="30d"?"bg-primary text-primary-foreground":""}`,onClick:()=>{o("30d"),s(H(new Date,30)),c(new Date)},children:"Last 30 days"}),e.jsx(R,{type:"button",variant:t==="custom"?"default":"outline",size:"sm",className:`h-8 ${t==="custom"?"bg-primary text-primary-foreground":""}`,onClick:()=>o("custom"),children:"Custom"}),t==="custom"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:j,onChange:p=>{const x=new Date(p.target.value);if(x.getTime()>i.getTime()){s(x),c(x);return}s(x)},className:"h-8 rounded-md border border-input bg-background px-2 text-sm"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"to"}),e.jsx("input",{type:"date",value:v,onChange:p=>{const x=new Date(p.target.value);if(x.getTime()<a.getTime()){c(x),s(x);return}c(x)},className:"h-8 rounded-md border border-input bg-background px-2 text-sm"})]}),t==="custom"&&d&&e.jsx("span",{className:"text-sm text-destructive",children:"From date must be before or equal to To date"}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[t==="custom"&&d&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Export disabled while date range is invalid"}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>{h()},disabled:n,children:[e.jsx(pe,{className:n?"h-4 w-4 animate-spin":"h-4 w-4"}),"Refresh"]}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>se(),disabled:t==="custom"&&d||!r.tickets||r.tickets.length===0,title:t==="custom"&&d?"Fix date range to export":!r.tickets||r.tickets.length===0?"No tickets in selected range":void 0,children:[e.jsx(be,{className:"h-4 w-4"}),"Export CSV"]}),e.jsxs(R,{type:"button",variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>window.print(),disabled:t==="custom"&&d||!r.tickets||r.tickets.length===0,title:t==="custom"&&d?"Fix date range to export":!r.tickets||r.tickets.length===0?"No tickets in selected range":void 0,children:[e.jsx(we,{className:"h-4 w-4"}),"Export PDF"]})]})]}),e.jsxs(_.div,{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4 print-summary-grid",...L(.12),children:[e.jsx(w,{index:0,title:"Total Tickets",value:r.total,icon:xe,description:"Selected range"}),e.jsx(w,{index:1,title:"Open",value:r.open,icon:$,color:"text-green-500",description:"Currently open",onClick:()=>b("/tickets?status=open"),clickHint:"Open open tickets"}),e.jsx(w,{index:2,title:"In Progress",value:r.inProgress,icon:V,color:"text-yellow-500",description:"Being worked on",onClick:()=>b("/tickets?status=in_progress"),clickHint:"Open in-progress tickets"}),e.jsx(w,{index:3,title:"Closed",value:r.closed,icon:ge,color:"text-blue-500",description:"Resolved",onClick:()=>b("/tickets?status=closed"),clickHint:"Open closed tickets"}),e.jsx(w,{index:4,title:"Median Resolution",value:r.medianResolutionHours!==null?`${r.medianResolutionHours.toFixed(1)}h`:"—",icon:V,description:"Typical time to close"}),e.jsx(w,{index:5,title:"Overdue Tickets",value:r.overdue,icon:$,color:"text-red-600",description:"Past SLA",onClick:()=>b("/tickets?filter=overdue"),clickHint:"Review overdue tickets"}),e.jsx(w,{index:6,title:"SLA Breaches",value:r.slaBreaches,icon:$,color:"text-red-600",description:"Tickets exceeding SLA",onClick:()=>b("/tickets?sla=breach"),clickHint:"Open SLA breach ticket list"})]}),e.jsxs(_.div,{className:"grid gap-6 lg:grid-cols-2 print-grid-2",...L(.16),children:[e.jsxs(P,{children:[e.jsx(M,{children:e.jsx(A,{children:"Tickets Over Time"})}),e.jsx(B,{children:l&&l.length>0?e.jsx(De,{data:l}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No trend data available."})})]}),e.jsxs(P,{children:[e.jsx(M,{children:e.jsx(A,{children:"Status Distribution"})}),e.jsx(B,{children:e.jsx(_e,{data:{open:r.open,inProgress:r.inProgress,closed:r.closed}})})]}),e.jsxs(P,{children:[e.jsx(M,{children:e.jsx(A,{children:"Daily Ticket Volume"})}),e.jsx(B,{children:l&&l.length>0?e.jsx(Le,{data:l}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No daily ticket data available."})})]})]})]}):null};export{ze as default};
