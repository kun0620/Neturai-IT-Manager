import{u as ae,r as m,j as e}from"./vendor-react-BzKcyMZF.js";import{b as te,u as w,c as re}from"./vendor-tanstack-CEPwOq2U.js";import{d as z,g as ie,m as ne,c as ce,V as de,B as p,R as le,f as oe,s as c,n as b,a as D}from"./index-W22mHG5Q.js";import{B as f}from"./badge-CibXaFky.js";import{C as K,a as B,b as L,d as U}from"./card-D2xMQo-S.js";import{S as ue}from"./switch-DfIyLQmc.js";import{S as _,a as k,b as C,c as S,d as i}from"./select-D46hviyT.js";import{E as me}from"./ErrorState-Bo0iD392.js";import{R as xe}from"./refresh-cw-OojOoMPA.js";import{s as V}from"./subDays-bnZFagG5.js";import"./vendor-radix-I-8VOjah.js";import"./vendor-supabase-Dc5vJ71z.js";/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=z("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=z("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]),q=20;function qe(){var E,R,I;const d=te(),$=ae(),{session:y}=ie(),t=(E=y==null?void 0:y.user)==null?void 0:E.id,[x,H]=m.useState("all"),[l,O]=m.useState("30d"),[h,G]=m.useState("all"),[o,u]=m.useState(1),g=w({queryKey:["notification-preferences",t],enabled:!!t,queryFn:async()=>{if(!t)return null;const{data:s,error:a}=await c.from("user_notification_preferences").select("*").eq("user_id",t).maybeSingle();if(a)throw a;return s??null}}),F=re({mutationFn:async s=>{if(!t)return;const a=g.data,{error:n}=await c.from("user_notification_preferences").upsert({user_id:t,receive_new_ticket:(a==null?void 0:a.receive_new_ticket)??!0,receive_status_change:(a==null?void 0:a.receive_status_change)??!0,receive_priority_change:(a==null?void 0:a.receive_priority_change)??!0,...s,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(n)throw n},onSuccess:async()=>{await d.invalidateQueries({queryKey:["notification-preferences",t]}),D("Preferences updated")},onError:s=>{const a=s instanceof Error?s.message:"Unknown error";b("Failed to update preferences",a)}}),M=m.useMemo(()=>l==="7d"?V(new Date,7).toISOString():l==="30d"?V(new Date,30).toISOString():null,[l]),r=w({queryKey:["notifications-page",t,x,l,h,o],enabled:!!t,queryFn:async()=>{if(!t)return{rows:[],count:0};let s=c.from("notifications").select("*",{count:"exact"}).eq("user_id",t).order("created_at",{ascending:!1});x==="unread"&&(s=s.eq("is_read",!1)),x==="read"&&(s=s.eq("is_read",!0)),h!=="all"&&(s=s.eq("type",h)),M&&(s=s.gte("created_at",M));const a=(o-1)*q,n=a+q-1,{data:ee,error:Q,count:se}=await s.range(a,n);if(Q)throw Q;return{rows:(ee??[]).map(T=>({...T,is_read:T.is_read??!1})),count:se??0}}}),Z=w({queryKey:["notifications-unread-summary",t],enabled:!!t,queryFn:async()=>{if(!t)return 0;const{count:s,error:a}=await c.from("notifications").select("id",{count:"exact",head:!0}).eq("user_id",t).eq("is_read",!1);if(a)throw a;return s??0}}),j=((R=r.data)==null?void 0:R.rows)??[],P=((I=r.data)==null?void 0:I.count)??0,A=Z.data??0,v=Math.max(1,Math.ceil(P/q)),J=Array.from(new Set(j.map(s=>s.type).filter(Boolean))).sort((s,a)=>s.localeCompare(a)),N=g.data,W=async s=>{if(s.is_read)return;const{error:a}=await c.from("notifications").update({is_read:!0}).eq("id",s.id);if(a){b("Failed to mark notification as read",a.message);return}await Promise.all([d.invalidateQueries({queryKey:["notifications-page"]}),d.invalidateQueries({queryKey:["notifications-unread-summary"]})])},X=async()=>{if(!t)return;const{error:s}=await c.from("notifications").update({is_read:!0}).eq("user_id",t).eq("is_read",!1);if(s){b("Failed to mark all as read",s.message);return}D("Notifications updated","All notifications are marked as read"),await Promise.all([d.invalidateQueries({queryKey:["notifications-page"]}),d.invalidateQueries({queryKey:["notifications-unread-summary"]})])},Y=async s=>{await W(s),s.ticket_id&&$(`/tickets?open_ticket=${encodeURIComponent(s.ticket_id)}`)};if(r.isError){const s=r.error;return e.jsx("div",{className:"p-4 md:p-6",children:e.jsx(me,{title:"Failed to load notifications",message:s.message})})}return e.jsxs(ne.div,{className:"flex flex-col gap-4 p-4 md:p-6",...ce(0),children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Neturai IT Manager"}),e.jsxs("h1",{className:"flex items-center gap-2 text-3xl font-semibold",children:[e.jsx(de,{className:"h-7 w-7"})," Notifications"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(f,{variant:"secondary",children:["Unread: ",A]}),e.jsxs(f,{variant:"outline",children:["Total: ",P]})]})]}),e.jsxs(K,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-base",children:"My Notification Preferences"})}),e.jsx(U,{className:"space-y-3",children:[{key:"receive_new_ticket",label:"New ticket assigned",description:"Notify when a new ticket is assigned or created for you."},{key:"receive_status_change",label:"Ticket status changes",description:"Notify when ticket status changes."},{key:"receive_priority_change",label:"Ticket priority changes",description:"Notify when ticket priority changes."}].map(s=>{const a=(N==null?void 0:N[s.key])??!0;return e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-border/70 p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]}),e.jsx(ue,{checked:a,disabled:F.isPending||g.isLoading,onCheckedChange:n=>F.mutate({[s.key]:n})})]},s.key)})})]}),e.jsxs(K,{children:[e.jsx(B,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(L,{className:"mr-auto text-base",children:"Inbox"}),e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>void r.refetch(),disabled:r.isFetching,children:[e.jsx(xe,{className:r.isFetching?"h-4 w-4 animate-spin":"h-4 w-4"}),"Refresh"]}),e.jsxs(p,{variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>void X(),disabled:A===0,children:[e.jsx(he,{className:"h-4 w-4"}),"Mark all as read"]})]})}),e.jsxs(U,{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 rounded-md border border-border/70 bg-muted/20 p-2",children:[e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(_,{value:x,onValueChange:s=>{H(s),u(1)},children:[e.jsx(k,{className:"h-8 w-[130px] text-sm",children:e.jsx(C,{placeholder:"Read state"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"All"}),e.jsx(i,{value:"unread",children:"Unread"}),e.jsx(i,{value:"read",children:"Read"})]})]}),e.jsxs(_,{value:l,onValueChange:s=>{O(s),u(1)},children:[e.jsx(k,{className:"h-8 w-[130px] text-sm",children:e.jsx(C,{placeholder:"Date range"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"All time"}),e.jsx(i,{value:"7d",children:"Last 7 days"}),e.jsx(i,{value:"30d",children:"Last 30 days"})]})]}),e.jsxs(_,{value:h,onValueChange:s=>{G(s),u(1)},children:[e.jsx(k,{className:"h-8 w-[170px] text-sm",children:e.jsx(C,{placeholder:"Type"})}),e.jsxs(S,{children:[e.jsx(i,{value:"all",children:"All types"}),J.map(s=>e.jsx(i,{value:s,children:s},s))]})]})]}),r.isLoading?e.jsx("div",{className:"space-y-2",children:Array.from({length:5}).map((s,a)=>e.jsxs("div",{className:"animate-pulse rounded-md border border-border/60 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-16 rounded bg-muted/60"}),e.jsx("div",{className:"h-4 w-12 rounded bg-muted/50"})]}),e.jsx("div",{className:`mt-2 h-4 rounded bg-muted/60 ${a%3===0?"w-3/4":a%3===1?"w-2/3":"w-4/5"}`}),e.jsx("div",{className:`mt-1 h-3 rounded bg-muted/50 ${a%3===0?"w-1/2":a%3===1?"w-2/5":"w-3/5"}`}),e.jsx("div",{className:"mt-2 h-3 w-24 rounded bg-muted/40"})]},a))}):j.length===0?e.jsx(le,{title:"No notifications",message:"Try adjusting your filters."}):e.jsx("div",{className:"space-y-2",children:j.map(s=>e.jsxs("button",{type:"button",className:`w-full rounded-md border p-3 text-left transition-colors hover:bg-muted/40 ${s.is_read?"border-border/70":"border-primary/40 bg-primary/5"}`,onClick:()=>void Y(s),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{variant:"outline",className:"text-[10px] uppercase",children:s.type}),!s.is_read&&e.jsx(f,{variant:"secondary",className:"text-[10px]",children:"Unread"})]}),e.jsx("p",{className:"mt-1 text-sm font-medium",children:s.title}),s.body&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:s.body}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:s.created_at?oe(new Date(s.created_at),"dd MMM yyyy HH:mm"):"â€”"})]},s.id))}),e.jsxs("div",{className:"flex items-center justify-between border-t border-border/60 pt-2 text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Page ",o," / ",v]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{variant:"outline",size:"sm",disabled:o<=1,onClick:()=>u(s=>Math.max(1,s-1)),children:"Previous"}),e.jsx(p,{variant:"outline",size:"sm",disabled:o>=v,onClick:()=>u(s=>Math.min(v,s+1)),children:"Next"})]})]})]})]})]})}export{qe as default};
