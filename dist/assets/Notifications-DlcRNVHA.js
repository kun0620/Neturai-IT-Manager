import{u as ae,r as u,j as e}from"./vendor-react-CqgMBxNQ.js";import{b as te,u as w,c as re}from"./vendor-tanstack-DVpCzg3k.js";import{d as F,c as ie,B as h,s as c,n as b,a as K}from"./index-DFoI8Gyt.js";import{B as f}from"./badge-BYTPeF6c.js";import{C as B,a as L,b as U,d as z}from"./card-CCsMzs-c.js";import{S as ne}from"./switch-B7d-zqfy.js";import{S as _,a as k,b as C,c as q,d as i}from"./select-BucmKwq7.js";import{E as ce}from"./EmptyState-GtDgzNl5.js";import{E as de}from"./ErrorState-dju_jAox.js";import{u as oe}from"./useAuth-Zyc7qEp4.js";import{m as le}from"./proxy-Cn5sRzkl.js";import{R as me}from"./refresh-cw-QnL5fLSt.js";import{s as H}from"./subDays-Dx0asAth.js";import{f as ue}from"./format-DBRio2gI.js";import"./vendor-radix-DW-K601O.js";import"./vendor-supabase-CegkeNa5.js";/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=F("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=F("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=F("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]),S=20;function Pe(){var I,Q,R;const d=te(),V=ae(),{session:y}=oe(),t=(I=y==null?void 0:y.user)==null?void 0:I.id,[x,$]=u.useState("all"),[o,O]=u.useState("30d"),[p,G]=u.useState("all"),[l,m]=u.useState(1),g=w({queryKey:["notification-preferences",t],enabled:!!t,queryFn:async()=>{if(!t)return null;const{data:s,error:a}=await c.from("user_notification_preferences").select("*").eq("user_id",t).maybeSingle();if(a)throw a;return s??null}}),M=re({mutationFn:async s=>{if(!t)return;const a=g.data,{error:n}=await c.from("user_notification_preferences").upsert({user_id:t,receive_new_ticket:(a==null?void 0:a.receive_new_ticket)??!0,receive_status_change:(a==null?void 0:a.receive_status_change)??!0,receive_priority_change:(a==null?void 0:a.receive_priority_change)??!0,...s,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(n)throw n},onSuccess:async()=>{await d.invalidateQueries({queryKey:["notification-preferences",t]}),K("Preferences updated")},onError:s=>{const a=s instanceof Error?s.message:"Unknown error";b("Failed to update preferences",a)}}),E=u.useMemo(()=>o==="7d"?H(new Date,7).toISOString():o==="30d"?H(new Date,30).toISOString():null,[o]),r=w({queryKey:["notifications-page",t,x,o,p,l],enabled:!!t,queryFn:async()=>{if(!t)return{rows:[],count:0};let s=c.from("notifications").select("*",{count:"exact"}).eq("user_id",t).order("created_at",{ascending:!1});x==="unread"&&(s=s.eq("is_read",!1)),x==="read"&&(s=s.eq("is_read",!0)),p!=="all"&&(s=s.eq("type",p)),E&&(s=s.gte("created_at",E));const a=(l-1)*S,n=a+S-1,{data:ee,error:T,count:se}=await s.range(a,n);if(T)throw T;return{rows:(ee??[]).map(D=>({...D,is_read:D.is_read??!1})),count:se??0}}}),Z=w({queryKey:["notifications-unread-summary",t],enabled:!!t,queryFn:async()=>{if(!t)return 0;const{count:s,error:a}=await c.from("notifications").select("id",{count:"exact",head:!0}).eq("user_id",t).eq("is_read",!1);if(a)throw a;return s??0}}),j=((Q=r.data)==null?void 0:Q.rows)??[],P=((R=r.data)==null?void 0:R.count)??0,A=Z.data??0,v=Math.max(1,Math.ceil(P/S)),J=Array.from(new Set(j.map(s=>s.type).filter(Boolean))).sort((s,a)=>s.localeCompare(a)),N=g.data,W=async s=>{if(s.is_read)return;const{error:a}=await c.from("notifications").update({is_read:!0}).eq("id",s.id);if(a){b("Failed to mark notification as read",a.message);return}await Promise.all([d.invalidateQueries({queryKey:["notifications-page"]}),d.invalidateQueries({queryKey:["notifications-unread-summary"]})])},X=async()=>{if(!t)return;const{error:s}=await c.from("notifications").update({is_read:!0}).eq("user_id",t).eq("is_read",!1);if(s){b("Failed to mark all as read",s.message);return}K("Notifications updated","All notifications are marked as read"),await Promise.all([d.invalidateQueries({queryKey:["notifications-page"]}),d.invalidateQueries({queryKey:["notifications-unread-summary"]})])},Y=async s=>{await W(s),s.ticket_id&&V(`/tickets?open_ticket=${encodeURIComponent(s.ticket_id)}`)};if(r.isError){const s=r.error;return e.jsx("div",{className:"p-4 md:p-6",children:e.jsx(de,{title:"Failed to load notifications",message:s.message})})}return e.jsxs(le.div,{className:"flex flex-col gap-4 p-4 md:p-6",...ie(0),children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Neturai IT Manager"}),e.jsxs("h1",{className:"flex items-center gap-2 text-3xl font-semibold",children:[e.jsx(xe,{className:"h-7 w-7"})," Notifications"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs(f,{variant:"secondary",children:["Unread: ",A]}),e.jsxs(f,{variant:"outline",children:["Total: ",P]})]})]}),e.jsxs(B,{children:[e.jsx(L,{className:"pb-3",children:e.jsx(U,{className:"text-base",children:"My Notification Preferences"})}),e.jsx(z,{className:"space-y-3",children:[{key:"receive_new_ticket",label:"New ticket assigned",description:"Notify when a new ticket is assigned or created for you."},{key:"receive_status_change",label:"Ticket status changes",description:"Notify when ticket status changes."},{key:"receive_priority_change",label:"Ticket priority changes",description:"Notify when ticket priority changes."}].map(s=>{const a=(N==null?void 0:N[s.key])??!0;return e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-border/70 p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]}),e.jsx(ne,{checked:a,disabled:M.isPending||g.isLoading,onCheckedChange:n=>M.mutate({[s.key]:n})})]},s.key)})})]}),e.jsxs(B,{children:[e.jsx(L,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(U,{className:"mr-auto text-base",children:"Inbox"}),e.jsxs(h,{variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>void r.refetch(),disabled:r.isFetching,children:[e.jsx(me,{className:r.isFetching?"h-4 w-4 animate-spin":"h-4 w-4"}),"Refresh"]}),e.jsxs(h,{variant:"outline",size:"sm",className:"h-8 gap-2",onClick:()=>void X(),disabled:A===0,children:[e.jsx(pe,{className:"h-4 w-4"}),"Mark all as read"]})]})}),e.jsxs(z,{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 rounded-md border border-border/70 bg-muted/20 p-2",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(_,{value:x,onValueChange:s=>{$(s),m(1)},children:[e.jsx(k,{className:"h-8 w-[130px] text-sm",children:e.jsx(C,{placeholder:"Read state"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"All"}),e.jsx(i,{value:"unread",children:"Unread"}),e.jsx(i,{value:"read",children:"Read"})]})]}),e.jsxs(_,{value:o,onValueChange:s=>{O(s),m(1)},children:[e.jsx(k,{className:"h-8 w-[130px] text-sm",children:e.jsx(C,{placeholder:"Date range"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"All time"}),e.jsx(i,{value:"7d",children:"Last 7 days"}),e.jsx(i,{value:"30d",children:"Last 30 days"})]})]}),e.jsxs(_,{value:p,onValueChange:s=>{G(s),m(1)},children:[e.jsx(k,{className:"h-8 w-[170px] text-sm",children:e.jsx(C,{placeholder:"Type"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"All types"}),J.map(s=>e.jsx(i,{value:s,children:s},s))]})]})]}),r.isLoading?e.jsx("div",{className:"space-y-2",children:Array.from({length:5}).map((s,a)=>e.jsxs("div",{className:"animate-pulse rounded-md border border-border/60 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-16 rounded bg-muted/60"}),e.jsx("div",{className:"h-4 w-12 rounded bg-muted/50"})]}),e.jsx("div",{className:`mt-2 h-4 rounded bg-muted/60 ${a%3===0?"w-3/4":a%3===1?"w-2/3":"w-4/5"}`}),e.jsx("div",{className:`mt-1 h-3 rounded bg-muted/50 ${a%3===0?"w-1/2":a%3===1?"w-2/5":"w-3/5"}`}),e.jsx("div",{className:"mt-2 h-3 w-24 rounded bg-muted/40"})]},a))}):j.length===0?e.jsx(ce,{title:"No notifications",message:"Try adjusting your filters."}):e.jsx("div",{className:"space-y-2",children:j.map(s=>e.jsxs("button",{type:"button",className:`w-full rounded-md border p-3 text-left transition-colors hover:bg-muted/40 ${s.is_read?"border-border/70":"border-primary/40 bg-primary/5"}`,onClick:()=>void Y(s),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{variant:"outline",className:"text-[10px] uppercase",children:s.type}),!s.is_read&&e.jsx(f,{variant:"secondary",className:"text-[10px]",children:"Unread"})]}),e.jsx("p",{className:"mt-1 text-sm font-medium",children:s.title}),s.body&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:s.body}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:s.created_at?ue(new Date(s.created_at),"dd MMM yyyy HH:mm"):"â€”"})]},s.id))}),e.jsxs("div",{className:"flex items-center justify-between border-t border-border/60 pt-2 text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Page ",l," / ",v]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",disabled:l<=1,onClick:()=>m(s=>Math.max(1,s-1)),children:"Previous"}),e.jsx(h,{variant:"outline",size:"sm",disabled:l>=v,onClick:()=>m(s=>Math.min(v,s+1)),children:"Next"})]})]})]})]})]})}export{Pe as default};
