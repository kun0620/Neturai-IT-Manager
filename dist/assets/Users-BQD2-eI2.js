import{j as e,r as l,g as Ne}from"./vendor-react-CQhyLJhi.js";import{b as R,c as ye,u as be}from"./vendor-tanstack-CEdBqcEP.js";import{A as _e,a as Ce,b as De,c as we,d as ke,e as Se,f as Ee,g as Pe,i as Ae,D as Le}from"./alert-dialog-jimNj9Mg.js";import{u as qe,D as ie,k as le,l as oe,m as de,n as ce,o as ue,S as me,f as pe,g as fe,i as he,j as q}from"./useCurrentProfile-Bk_xV3Os.js";import{n as Fe,a as Ke,s as y,B as L,h as xe}from"./index-C_wQioo6.js";import{L as Ue}from"./LoadingSkeleton-igMf2rTD.js";import"./vendor-charts-yMFR7OPP.js";import"./vendor-radix-GaIC7jQ4.js";import"./vendor-supabase-ERkXFu1W.js";const $e=({isOpen:n,onClose:i,userId:o,userName:f,onSuccess:b})=>{const m=R(),j=ye({mutationFn:async v=>{const{data:h,error:t}=await y.functions.invoke("delete-user",{body:JSON.stringify({userId:v})});if(t)throw t;if(h.error)throw new Error(h.error);return h},onSuccess:()=>{m.invalidateQueries({queryKey:["admin-users"]}),Ke("User Deleted",`User "${f}" has been successfully removed.`),b(),i()},onError:v=>{Fe("Failed to Delete User",v.message)}}),w=()=>{j.mutate(o)};return e.jsx(_e,{open:n,onOpenChange:i,children:e.jsxs(Ce,{children:[e.jsxs(De,{children:[e.jsx(we,{children:"Confirm Deletion"}),e.jsxs(ke,{children:["Are you sure you want to delete user"," ",e.jsxs("span",{className:"font-semibold text-foreground",children:['"',f,'"']}),"? This action cannot be undone."]})]}),e.jsxs(Se,{children:[e.jsx(Ee,{disabled:j.isPending,children:"Cancel"}),e.jsx(Pe,{onClick:w,disabled:j.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:j.isPending?"Deleting...":"Delete"})]})]})})};async function Oe(){const{data:n,error:i}=await y.from("profiles").select(`
      id,
      name,
      full_name,
      email,
      role,
      created_at,
      department,
      location,
      preferred_contact,
      assigned_asset:assets(
        id,
        name,
        asset_code,
        serial_number,
        asset_type:asset_types(key, name)
      )
    `).order("name");if(i)throw i;return n??[]}function Te(){return be({queryKey:["admin-users"],queryFn:Oe})}const Ve=()=>{const n=R();return ye({mutationFn:async({userId:i,role:o})=>{const{error:f}=await y.from("profiles").update({role:o}).eq("id",i);if(f)throw new Error(f.message)},onSuccess:()=>{n.invalidateQueries({queryKey:["admin-users"]})}})};async function ge(n,i,o,f){var j,w,v,h;if(o){const{data:t,error:_}=await y.from("assets").select(`
        id,
        asset_type:asset_types(key, name)
      `).eq("id",n).maybeSingle();if(_)throw _;const F=((w=(j=t==null?void 0:t.asset_type)==null?void 0:j.key)==null?void 0:w.toLowerCase())??"",N=((h=(v=t==null?void 0:t.asset_type)==null?void 0:v.name)==null?void 0:h.toLowerCase())??"";if(F==="laptop"||F==="desktop"||N==="laptop"||N==="desktop"){const{data:k,error:K}=await y.from("assets").select(`
          id,
          asset_type:asset_types(key, name)
        `).eq("assigned_to",o);if(K)throw K;if((k??[]).some(g=>{var C,c,D,P;if(g.id===n)return!1;const S=((c=(C=g.asset_type)==null?void 0:C.key)==null?void 0:c.toLowerCase())??"",E=((P=(D=g.asset_type)==null?void 0:D.name)==null?void 0:P.toLowerCase())??"";return S==="laptop"||S==="desktop"||E==="laptop"||E==="desktop"}))throw new Error("This user already has a laptop/desktop assigned.")}}const b={assigned_to:o,status:o?"Assigned":"Available"},{error:m}=await y.from("assets").update(b).eq("id",n);if(m)throw m;if(i){const{error:t}=await y.from("profiles").update({assigned_asset_id:null}).eq("id",i);if(t)throw t}if(o){const{error:t}=await y.from("profiles").update({assigned_asset_id:n}).eq("id",o);if(t)throw t}await Ae([{assetId:n,action:o?"assign":"unassign",field:"assigned_to",oldValue:i,newValue:o,performedBy:f},{assetId:n,action:"status_change",field:"status",oldValue:i?"Assigned":"Available",newValue:o?"Assigned":"Available",performedBy:f}])}function ze({embedded:n=!1}){const{data:i,isLoading:o}=Te(),{mutate:f}=Ve(),{can:b,profile:m,loading:j}=qe(),w=R(),v=b("user.view"),h=b("user.role.update"),t=b("user.delete"),_=h,[F,N]=l.useState(!1),[x,k]=l.useState(null),[K,U]=l.useState(!1),[g,S]=l.useState(null),[E,C]=l.useState(!1),[c,D]=l.useState(null),[P,Q]=l.useState(""),[B,H]=l.useState(""),[Y,J]=l.useState(""),[W,G]=l.useState(""),[A,I]=l.useState(""),[$,V]=l.useState([]),[X,z]=l.useState(!1),[Z,ee]=Ne(),se=m==null?void 0:m.id,ae=l.useCallback(async s=>{z(!0);const{data:a,error:r}=await y.from("assets").select(`
        id,
        name,
        asset_code,
        serial_number,
        assigned_to,
        asset_type:asset_types(key, name)
      `).or(`assigned_to.is.null,assigned_to.eq.${s}`);if(r){V([]),z(!1);return}const d=(a??[]).filter(u=>{var T,te,re,ne;const p=((te=(T=u.asset_type)==null?void 0:T.key)==null?void 0:te.toLowerCase())??"",O=((ne=(re=u.asset_type)==null?void 0:re.name)==null?void 0:ne.toLowerCase())??"";return(p==="laptop"||p==="desktop"||O==="laptop"||O==="desktop")&&(u.assigned_to===null||u.assigned_to===s)});V(d),z(!1)},[]),M=l.useCallback(s=>{var a;D(s),Q(s.full_name??s.name??""),H(s.department??""),J(s.location??""),G(s.preferred_contact??""),I(((a=s.assigned_asset)==null?void 0:a.id)??""),C(!0),ae(s.id)},[ae]);if(l.useEffect(()=>{const s=Z.get("editUserId");if(!s||!i||!_||E)return;const a=i.find(r=>r.id===s);a&&(M(a),ee(r=>{const d=new URLSearchParams(r);return d.delete("editUserId"),d}))},[Z,i,_,E,ee,M]),o||j)return e.jsxs("div",{className:"flex flex-col gap-6 p-4 md:p-6",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-5 w-1/2 rounded bg-muted animate-pulse"}),e.jsx(Ue,{count:6,className:"md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3"})]});if(!v)return e.jsx("div",{className:"p-6 text-muted-foreground",children:"You do not have permission to view users."});const je=async()=>{var d;if(!c)return;const{error:s}=await y.from("profiles").update({full_name:P||null,name:P||null,department:B||null,location:Y||null,preferred_contact:W||null}).eq("id",c.id);if(s){xe("Failed to update user profile");return}const a=((d=c.assigned_asset)==null?void 0:d.id)??"",r=(m==null?void 0:m.id)??null;if(A!==a){const u=$.filter(p=>p.assigned_to===c.id&&p.id!==A);for(const p of u)await ge(p.id,c.id,null,r);if(A){const p=$.find(T=>T.id===A),O=(p==null?void 0:p.assigned_to)??null;await ge(A,O,c.id,r)}}w.invalidateQueries({queryKey:["admin-users"]}),C(!1),D(null)},ve=[{accessorKey:"name",header:"Name"},{accessorKey:"email",header:"Email"},{accessorKey:"role",header:"Role",cell:({row:s})=>{const a=s.original,r=a.id===se;return h?r?e.jsxs("span",{className:"capitalize text-muted-foreground",children:[a.role," (you)"]}):e.jsxs(me,{value:a.role,onValueChange:d=>{k({userId:a.id,email:a.email,role:d}),N(!0)},children:[e.jsx(pe,{className:"w-[120px]",children:e.jsx(fe,{})}),e.jsxs(he,{children:[e.jsx(q,{value:"admin",children:"admin"}),e.jsx(q,{value:"it",children:"it"}),e.jsx(q,{value:"user",children:"user"})]})]}):e.jsx("span",{className:"capitalize",children:a.role})}},{accessorKey:"department",header:"Department",cell:({row:s})=>s.original.department||"-"},{id:"device",header:"Device",cell:({row:s})=>{var u;const a=s.original.assigned_asset;if(!a)return"-";const r=((u=a.asset_type)==null?void 0:u.name)??"Device",d=a.serial_number??a.asset_code??"";return d?`${a.name} (${r}: ${d})`:`${a.name} (${r})`}},{accessorKey:"preferred_contact",header:"Preferred Contact",cell:({row:s})=>s.original.preferred_contact||"-"},{id:"actions",header:"Actions",cell:({row:s})=>{const a=s.original,r=a.id===se;return!t&&!_?null:e.jsxs("div",{className:"flex items-center gap-2",children:[_&&e.jsx(L,{size:"sm",variant:"outline",onClick:()=>M(a),children:"Edit Profile"}),t&&e.jsx(L,{variant:"destructive",size:"sm",disabled:r,onClick:()=>{S({userId:a.id,userName:a.name??a.email??"User"}),U(!0)},children:"Delete"})]})}}];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:n?"space-y-4":"flex flex-col gap-6 p-4 md:p-6",children:[!n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Neturai IT Manager"}),e.jsx("h1",{className:"text-3xl font-semibold",children:"User Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Control access and roles across the organization."})]}),n&&e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage users, roles, departments, and primary devices."})}),e.jsx("div",{className:n?"rounded-md border":"",children:e.jsx(Le,{columns:ve,data:i??[]})})]}),e.jsx(ie,{open:F,onOpenChange:N,children:e.jsxs(le,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Confirm role change"}),e.jsx(ce,{className:"sr-only",children:"Confirm the selected role update for this user."})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Change role of ",e.jsx("b",{children:x==null?void 0:x.email})," to"," ",e.jsx("b",{className:"capitalize",children:x==null?void 0:x.role})," ?"]}),e.jsxs(ue,{children:[e.jsx(L,{variant:"outline",onClick:()=>{N(!1),k(null)},children:"Cancel"}),e.jsx(L,{onClick:()=>{if(x){if(!h){xe("You do not have permission to update user role"),N(!1),k(null);return}f({userId:x.userId,role:x.role}),N(!1),k(null)}},children:"Confirm"})]})]})}),e.jsx($e,{isOpen:K,onClose:()=>{U(!1),S(null)},userId:(g==null?void 0:g.userId)??"",userName:(g==null?void 0:g.userName)??"",onSuccess:()=>{U(!1),S(null)}}),e.jsx(ie,{open:E,onOpenChange:s=>{C(s),s||(D(null),V([]))},children:e.jsxs(le,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Edit user profile"}),e.jsx(ce,{className:"sr-only",children:"Update user profile fields and assigned primary device."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Full Name"}),e.jsx("input",{className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:P,onChange:s=>Q(s.target.value),placeholder:"Full name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Email"}),e.jsx("input",{className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:(c==null?void 0:c.email)??"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Department"}),e.jsx("input",{className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:B,onChange:s=>H(s.target.value),placeholder:"Department"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Location"}),e.jsx("input",{className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:Y,onChange:s=>J(s.target.value),placeholder:"Location"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Preferred Contact"}),e.jsx("input",{className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:W,onChange:s=>G(s.target.value),placeholder:"Phone number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Primary Device"}),e.jsxs(me,{value:A,onValueChange:s=>I(s),disabled:X,children:[e.jsx(pe,{children:e.jsx(fe,{placeholder:"Select Laptop/Desktop"})}),e.jsxs(he,{children:[e.jsx(q,{value:"",children:"None"}),$.map(s=>{var u;const a=((u=s.asset_type)==null?void 0:u.name)??"Device",r=s.serial_number??s.asset_code??"",d=r?`${s.name} (${a}: ${r})`:`${s.name} (${a})`;return e.jsx(q,{value:s.id,children:d},s.id)})]})]}),!X&&$.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"This user has no assigned laptop/desktop devices."})]})]}),e.jsxs(ue,{children:[e.jsx(L,{variant:"outline",onClick:()=>{C(!1),D(null)},children:"Cancel"}),e.jsx(L,{onClick:je,children:"Save"})]})]})})]})}function Ie(){return e.jsx(ze,{})}export{ze as UserManagementPanel,Ie as default};
