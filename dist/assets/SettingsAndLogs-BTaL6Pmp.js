import{j as e,r as d,g as Xe}from"./vendor-react-CQhyLJhi.js";import{T as Je,a as We,b as q,c as E}from"./tabs-u7_umfqf.js";import{d as Ze,b as P,C as es,s as j,B as S,I as le,X as ss,m as se,c as te,O as ae,S as ts,f as as,a as L,n as c}from"./index-C_wQioo6.js";import{S as is}from"./switch-Cx9f6Csp.js";import{u as ns,S as Ne,f as Se,g as we,i as Ce,j as F,T as ie,a as ne,b as A,c as f,d as re,e as p}from"./useCurrentProfile-Bk_xV3Os.js";import{o as rs,C as os}from"./vendor-radix-GaIC7jQ4.js";import{u as M,b as U,c as R}from"./vendor-tanstack-CEdBqcEP.js";import{P as ls,u as cs,T as ds}from"./useUsers-9LiriRzz.js";import{L as us}from"./LoadingSkeleton-igMf2rTD.js";import{A as be,a as _e,b as Le,c as Ae,d as Pe,e as ke,f as De,g as Te}from"./alert-dialog-jimNj9Mg.js";import{m as ms}from"./mapLogToText-BvzNOTVA.js";import{UserManagementPanel as gs}from"./Users-BQD2-eI2.js";import"./vendor-charts-yMFR7OPP.js";import"./vendor-supabase-ERkXFu1W.js";/**
 * @license lucide-react v0.321.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=Ze("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]),qe=({className:t,...a})=>e.jsx("nav",{role:"navigation","aria-label":"pagination",className:P("mx-auto flex w-full justify-center",t),...a});qe.displayName="Pagination";const Ee=d.forwardRef(({className:t,...a},n)=>e.jsx("ul",{ref:n,className:P("flex flex-row items-center gap-1",t),...a}));Ee.displayName="PaginationContent";const H=d.forwardRef(({className:t,...a},n)=>e.jsx("li",{ref:n,className:P("",t),...a}));H.displayName="PaginationItem";const V=({className:t,isActive:a,size:n="icon",...o})=>e.jsx("a",{"aria-current":a?"page":void 0,className:P(es({variant:a?"outline":"ghost",size:n}),t),...o});V.displayName="PaginationLink";const Fe=({className:t,...a})=>e.jsxs(V,{"aria-label":"Go to previous page",size:"default",className:P("gap-1 pl-2.5",t),...a,children:[e.jsx(rs,{className:"h-4 w-4"}),e.jsx("span",{children:"Previous"})]});Fe.displayName="PaginationPrevious";const Ie=({className:t,...a})=>e.jsxs(V,{"aria-label":"Go to next page",size:"default",className:P("gap-1 pr-2.5",t),...a,children:[e.jsx("span",{children:"Next"}),e.jsx(os,{className:"h-4 w-4"})]});Ie.displayName="PaginationNext";async function xs(){const{data:t,error:a}=await j.from("settings").select("*");if(a)throw new Error(a.message);return t}async function fs(t){const{key:a,value:n}=t;if(!a||n===void 0)throw new Error("Setting key and value are required for update.");const{data:o,error:l}=await j.from("settings").upsert({key:a,value:n,updated_at:new Date().toISOString()}).select().single();if(l)throw new Error(l.message);return o}function ps(){return M({queryKey:["settings"],queryFn:xs})}function js(){const t=U();return R({mutationFn:fs,onSuccess:()=>{t.invalidateQueries({queryKey:["settings"]})}})}async function ys(){const{data:t,error:a}=await j.from("ticket_categories").select("*").order("name",{ascending:!0});if(a)throw new Error(a.message);return t}async function vs(t){const{data:a,error:n}=await j.from("ticket_categories").insert(t).select().single();if(n)throw new Error(n.message);return a}async function Ns(t){const{id:a,name:n}=t,{data:o,error:l}=await j.from("ticket_categories").update({name:n,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(l)throw new Error(l.message);return o}async function Ss(t){const{error:a}=await j.from("ticket_categories").delete().eq("id",t);if(a)throw new Error(a.message)}function ws(){return M({queryKey:["ticket_categories"],queryFn:ys})}async function Cs(){const{data:t,error:a}=await j.rpc("get_issue_categories_distribution");if(a)throw new Error(a.message);return t??[]}function bs(){return M({queryKey:["ticket_categories","stats"],queryFn:Cs})}function _s(){const t=U();return R({mutationFn:vs,onSuccess:()=>{t.invalidateQueries({queryKey:["ticket_categories"]})}})}function Ls(){const t=U();return R({mutationFn:Ns,onSuccess:()=>{t.invalidateQueries({queryKey:["ticket_categories"]})}})}function As(){const t=U();return R({mutationFn:Ss,onSuccess:()=>{t.invalidateQueries({queryKey:["ticket_categories"]})}})}async function Ps(){const{data:t,error:a}=await j.from("sla_policies").select("*").order("priority",{ascending:!0});if(a)throw new Error(a.message);return t}async function ks(t){const{id:a,response_time_hours:n,resolution_time_hours:o}=t,{data:l,error:u}=await j.from("sla_policies").update({response_time_hours:n,resolution_time_hours:o,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(u)throw new Error(u.message);return l}function Ds(){return M({queryKey:["sla_policies"],queryFn:Ps})}function Ts(){const t=U();return R({mutationFn:ks,onSuccess:()=>{t.invalidateQueries({queryKey:["sla_policies"]})}})}async function qs(t,a,n){const o=(t-1)*a;let l=j.from("logs").select(`
        *,
        profiles (
          name,
          email
        )
      `).order("created_at",{ascending:!1}).range(o,o+a-1);n&&(l=l.or(`action.ilike.%${n}%,details.ilike.%${n}%`));const{data:u,error:N,count:k}=await l;if(N)throw N;return{data:u??[],count:k??0}}function Es(t,a,n){return M({queryKey:["logs",t,a,n],queryFn:()=>qs(t,a,n),placeholderData:o=>o})}function oe({value:t,placeholder:a="—",onSave:n}){const[o,l]=d.useState(!1),[u,N]=d.useState(t??""),[k,m]=d.useState(!1);async function B(){m(!0),await n(u||null),m(!1),l(!1)}return o?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{value:u,onChange:D=>N(D.target.value),className:"h-8"}),e.jsx(S,{size:"icon",onClick:B,disabled:k,children:e.jsx(hs,{className:"h-4 w-4"})}),e.jsx(S,{size:"icon",variant:"ghost",onClick:()=>{N(t??""),l(!1)},children:e.jsx(ss,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t||a}),e.jsx(S,{size:"icon",variant:"ghost",onClick:()=>l(!0),children:e.jsx(ls,{className:"h-4 w-4"})})]})}const $s=()=>{const[t,a]=Xe(),n=t.get("tab"),o=["general","users","categories","sla","logs"],l=o.includes(n)?n:"general",{data:u,isLoading:N}=ps(),k=js(),{data:m,isLoading:B}=ws(),{data:D,isLoading:Me}=bs(),ce=_s(),Ue=Ls(),G=As(),{data:y,isLoading:Re}=Ds(),Y=Ts(),{data:K,isLoading:Ke}=cs(),{isAdmin:de,isIT:ue}=ns(),[me,$]=d.useState(!1),[ge,X]=d.useState(null),[he,J]=d.useState("system"),[W,xe]=d.useState(null),[fe,pe]=d.useState(""),[w,Z]=d.useState(null),[Oe,O]=d.useState(!1),[je,Qe]=d.useState(""),[v,Q]=d.useState(1),ye=10,{data:C,isLoading:ze}=Es(v,ye,je),b=s=>s instanceof Error?s.message:"Unknown error";d.useEffect(()=>{var i,r,g;if(!u)return;$(((i=u.find(h=>h.key==="email_notifications_enabled"))==null?void 0:i.value)==="true");const s=(r=u.find(h=>h.key==="default_assignee_id"))==null?void 0:r.value;X(s??null),J(((g=u.find(h=>h.key==="theme_default"))==null?void 0:g.value)||"system")},[u,K]);const ee=async(s,i,r,g)=>{xe(s);try{await k.mutateAsync({key:s,value:i}),L(g??"Setting updated")}catch(h){c("Failed to update setting",b(h)),r==null||r()}finally{xe(null)}},He=s=>{s.preventDefault(),Q(1)},_=de||ue,z=de||ue,Ve=async()=>{if(!_){c("Permission denied","You cannot edit categories");return}const s=fe.trim();if(!s){c("Category name required");return}if(m==null?void 0:m.some(r=>r.name.trim().toLowerCase()===s.toLowerCase())){c("Category already exists");return}try{await ce.mutateAsync({name:s}),L("Category added"),pe("")}catch(r){c("Failed to add category",b(r))}},Be=async(s,i,r)=>{if(!_){c("Permission denied","You cannot edit categories");return}const g=(r??"").trim();if(!g){c("Category name required");return}if(g===i)return;if(m==null?void 0:m.some(x=>x.id!==s&&x.name.trim().toLowerCase()===g.toLowerCase())){c("Category already exists");return}try{await Ue.mutateAsync({id:s,name:g}),L("Category updated")}catch(x){c("Failed to update category",b(x))}},Ge=async()=>{if(w)try{await G.mutateAsync(w.id),L("Category deleted")}catch(s){c("Failed to delete category",b(s))}finally{Z(null)}},ve=async(s,i,r,g)=>{if(!z){c("Permission denied","You cannot edit SLA policies");return}const h=(r??"").trim();if(!h){c("Value required");return}const x=Number(h);if(!Number.isFinite(x)||x<0){c("Invalid number","Please enter a non-negative number");return}if(x!==g)try{await Y.mutateAsync({id:s,[i]:x}),L("SLA policy updated")}catch($e){c("Failed to update SLA policy",b($e))}},Ye=async()=>{if(!(y!=null&&y.length)){O(!1);return}const s={Low:{response:48,resolution:168},Medium:{response:24,resolution:72},High:{response:8,resolution:24},Critical:{response:1,resolution:4}};try{await Promise.all(y.map(i=>{const r=s[i.priority??""];return r?Y.mutateAsync({id:i.id,response_time_hours:r.response,resolution_time_hours:r.resolution}):Promise.resolve()})),L("SLA policies reset to defaults")}catch(i){c("Failed to reset SLA policies",b(i))}finally{O(!1)}},T=C?Math.ceil(C.count/ye):0;return N||B||Me||Re||Ke||ze?e.jsxs("div",{className:"flex flex-col gap-6 p-4 md:p-6",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-5 w-1/2 rounded bg-muted animate-pulse"}),e.jsx(us,{count:6,className:"md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3"})]}):e.jsxs(se.div,{className:"flex flex-col gap-6 p-4 md:p-6",...te(0),children:[e.jsxs(se.div,{className:"space-y-2",...te(.04),children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Neturai IT Manager"}),e.jsx("h1",{className:"text-3xl font-semibold",children:"Settings & Logs"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage system configuration and audit activity."})]}),e.jsx(se.div,{...te(.08),children:e.jsxs(Je,{value:l,onValueChange:s=>{o.includes(s)&&a({tab:s})},children:[e.jsxs(We,{className:"bg-muted/40 p-1 rounded-lg w-fit",children:[e.jsx(q,{value:"general",children:"General"}),e.jsx(q,{value:"users",children:"Users & Roles"}),e.jsx(q,{value:"categories",children:"Categories"}),e.jsx(q,{value:"sla",children:"SLA Policies"}),e.jsx(q,{value:"logs",children:"System Logs"})]}),e.jsx(E,{value:"general",className:"mt-6",children:e.jsx(I,{title:"General Settings",description:"Basic system configuration",children:e.jsxs("div",{className:"space-y-6 max-w-xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Email Notifications"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Receive ticket updates by email"})]}),e.jsx(is,{checked:me,disabled:W==="email_notifications_enabled",onCheckedChange:s=>{const i=me;$(s),ee("email_notifications_enabled",s?"true":"false",()=>$(i),"Email notifications updated")}})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Default Assignee"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Automatically assigned user"}),e.jsx("div",{className:"mt-2 max-w-sm",children:e.jsxs(Ne,{value:ge??"",onValueChange:s=>{const i=ge;X(s||null),ee("default_assignee_id",s||"",()=>X(i),"Default assignee updated")},disabled:W==="default_assignee_id",children:[e.jsx(Se,{children:e.jsx(we,{placeholder:"Select assignee"})}),e.jsxs(Ce,{position:"popper",sideOffset:6,children:[e.jsx(F,{value:"",children:"Unassigned"}),K==null?void 0:K.map(s=>e.jsx(F,{value:s.id,children:s.name||s.email||s.id},s.id))]})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Default Theme"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Application appearance"}),e.jsx("div",{className:"mt-2 max-w-xs",children:e.jsxs(Ne,{value:he,onValueChange:s=>{const i=he;J(s),ee("theme_default",s,()=>J(i),"Default theme updated")},disabled:W==="theme_default",children:[e.jsx(Se,{children:e.jsx(we,{placeholder:"Select theme"})}),e.jsxs(Ce,{position:"popper",sideOffset:6,children:[e.jsx(F,{value:"system",children:"System"}),e.jsx(F,{value:"light",children:"Light"}),e.jsx(F,{value:"dark",children:"Dark"})]})]})})]})]})})}),e.jsx(E,{value:"users",className:"mt-6",children:e.jsx(I,{title:"Users & Roles",description:"Manage access control and profile administration",children:e.jsx(gs,{embedded:!0})})}),e.jsx(E,{value:"categories",className:"mt-6",children:e.jsx(I,{title:"Issue Categories",description:"Ticket classification",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Manage categories"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Add, rename, or remove ticket categories"})]}),_&&e.jsxs("div",{className:"flex w-full gap-2 sm:w-auto",children:[e.jsx(le,{placeholder:"New category name",value:fe,onChange:s=>pe(s.target.value),className:"h-9"}),e.jsx(S,{onClick:Ve,disabled:ce.isPending,children:"Add"})]})]}),m!=null&&m.length?e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(A,{children:[e.jsx(f,{children:"Name"}),e.jsx(f,{className:"w-[140px] text-right",children:"Tickets"}),_&&e.jsx(f,{className:"w-[120px] text-right",children:"Actions"})]})}),e.jsx(re,{children:m.map(s=>{var i;return e.jsxs(A,{children:[e.jsx(p,{className:"font-medium",children:_?e.jsx(oe,{value:s.name,onSave:r=>Be(s.id,s.name,r)}):s.name}),e.jsx(p,{className:"text-right tabular-nums",children:((i=D==null?void 0:D.find(r=>r.category===s.name))==null?void 0:i.count)??0}),_&&e.jsx(p,{className:"text-right",children:e.jsx(S,{size:"icon",variant:"ghost",onClick:()=>Z({id:s.id,name:s.name}),children:e.jsx(ds,{className:"h-4 w-4"})})})]},s.id)})})]}):e.jsx(ae,{title:"No Categories",message:"No issue categories defined"})]})})}),e.jsx(E,{value:"sla",className:"mt-6",children:e.jsx(I,{title:"SLA Policies",description:"Response & resolution targets",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Edit response and resolution targets per priority"}),z&&e.jsx(S,{variant:"secondary",onClick:()=>O(!0),children:"Reset to defaults"})]}),y!=null&&y.length?e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(A,{children:[e.jsx(f,{children:"Priority"}),e.jsx(f,{children:"Response (hrs)"}),e.jsx(f,{children:"Resolution (hrs)"})]})}),e.jsx(re,{children:y.map(s=>e.jsxs(A,{children:[e.jsx(p,{className:"font-medium",children:s.priority}),e.jsx(p,{children:z?e.jsx(oe,{value:String(s.response_time_hours??0),onSave:i=>ve(s.id,"response_time_hours",i,s.response_time_hours??0)}):s.response_time_hours}),e.jsx(p,{children:z?e.jsx(oe,{value:String(s.resolution_time_hours??0),onSave:i=>ve(s.id,"resolution_time_hours",i,s.resolution_time_hours??0)}):s.resolution_time_hours})]},s.id))})]}):e.jsx(ae,{title:"No SLA Policies",message:"Define SLA rules per priority"})]})})}),e.jsx(E,{value:"logs",className:"mt-6 space-y-4",children:e.jsxs(I,{title:"System Logs",description:"Audit trail of system activity",children:[e.jsxs("form",{onSubmit:He,className:"flex gap-2 mb-4",children:[e.jsx(le,{placeholder:"Search logs...",value:je,onChange:s=>Qe(s.target.value)}),e.jsxs(S,{type:"submit",variant:"secondary",children:[e.jsx(ts,{className:"h-4 w-4 mr-1"}),"Search"]})]}),C!=null&&C.data.length?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border max-h-[420px] overflow-y-auto",children:e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(A,{children:[e.jsx(f,{children:"Time"}),e.jsx(f,{children:"User"}),e.jsx(f,{children:"Action"}),e.jsx(f,{children:"Details"})]})}),e.jsx(re,{children:C.data.map(s=>{var i,r;return e.jsxs(A,{children:[e.jsx(p,{children:s.created_at?as(new Date(s.created_at),"yyyy-MM-dd HH:mm:ss"):"—"}),e.jsx(p,{children:((i=s.profiles)==null?void 0:i.name)||((r=s.profiles)==null?void 0:r.email)||"—"}),e.jsx(p,{children:s.action}),e.jsx(p,{className:"space-y-1",children:(()=>{const g=s.details??null,{title:h,description:x}=ms(s.action,g);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:h}),x&&e.jsx("div",{className:"text-sm text-muted-foreground whitespace-pre-line",children:x})]})})()})]},s.id)})})]})}),T>1&&e.jsx(qe,{className:"mt-4",children:e.jsxs(Ee,{children:[e.jsx(H,{children:e.jsx(Fe,{"aria-disabled":v<=1,className:v<=1?"pointer-events-none opacity-50":"",onClick:()=>{v<=1||Q(s=>s-1)}})}),Array.from({length:T},(s,i)=>e.jsx(H,{children:e.jsx(V,{isActive:v===i+1,onClick:()=>Q(i+1),children:i+1})},i)),e.jsx(H,{children:e.jsx(Ie,{"aria-disabled":v>=T,className:v>=T?"pointer-events-none opacity-50":"",onClick:()=>{v>=T||Q(s=>s+1)}})})]})})]}):e.jsx(ae,{title:"No Logs",message:"No system activity recorded"})]})})]})}),e.jsx(be,{open:!!w,onOpenChange:s=>{s||Z(null)},children:e.jsxs(_e,{children:[e.jsxs(Le,{children:[e.jsx(Ae,{children:"Delete category"}),e.jsxs(Pe,{children:['This will permanently remove "',w==null?void 0:w.name,'". Existing tickets may lose their category.']})]}),e.jsxs(ke,{children:[e.jsx(De,{disabled:G.isPending,children:"Cancel"}),e.jsx(Te,{onClick:Ge,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:G.isPending,children:"Delete"})]})]})}),e.jsx(be,{open:Oe,onOpenChange:O,children:e.jsxs(_e,{children:[e.jsxs(Le,{children:[e.jsx(Ae,{children:"Reset SLA policies"}),e.jsx(Pe,{children:"This will restore default response and resolution times for all priorities."})]}),e.jsxs(ke,{children:[e.jsx(De,{children:"Cancel"}),e.jsx(Te,{onClick:Ye,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:Y.isPending,children:"Reset"})]})]})})]})};function I({title:t,description:a,children:n}){return e.jsxs("section",{className:"rounded-lg border bg-card",children:[e.jsxs("div",{className:"border-b px-6 py-4",children:[e.jsx("h2",{className:"font-semibold",children:t}),a&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a})]}),e.jsx("div",{className:"px-6 py-4",children:n})]})}export{$s as SettingsAndLogs};
